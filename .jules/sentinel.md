## 2025-02-27 - DOMPurify Configuration Gaps
**Vulnerability:** Found `DOMPurify.sanitize` usage that stripped `target="_blank"` attributes from external links, leading to broken functionality and potentially confusing behavior. Also, the external links lacked `rel="noopener noreferrer"`, which `DOMPurify` would strip if `target` was stripped, but if `target` was allowed, it would be vulnerable to reverse tabnabbing.
**Learning:** `DOMPurify` by default is very strict and strips `target` attributes. To allow them, `ADD_ATTR: ['target']` is needed. However, allowing `target` introduces tabnabbing risks, so `rel="noopener noreferrer"` MUST be added and preserved.
**Prevention:** When using `DOMPurify` for webviews, always check if `target="_blank"` is intended. If so, configure `DOMPurify` to allow `target` and ensure `rel="noopener noreferrer"` is present. Use explicit `DOMPurify` configuration rather than relying on defaults.

## 2025-02-27 - DOMPurify Misuse in Template Literals
**Vulnerability:** XSS vulnerability in `suggestionsPanelWebview.ts` where `DOMPurify.sanitize(url)` was used inside an `href` attribute in a template literal, instead of using the available `safeUrl` variable which validates the protocol.
**Learning:** `DOMPurify.sanitize()` returns sanitized HTML, not a safe attribute value. If the input is a malicious URL string (like `javascript:alert(1)`), `DOMPurify` might return it as-is (as text content) or strip it in ways that don't protect attribute context if interpolated directly. Injecting the result into `href="${sanitized}"` is dangerous.
**Prevention:** Always use `new URL(url).href` (and validate protocol) or a dedicated attribute encoder when injecting URLs into attributes. Do not rely on HTML sanitizers for attribute values. In this codebase, verify if existing sanitization utilities like `getSafeUrl` are correctly utilized.
