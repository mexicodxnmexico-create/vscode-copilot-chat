## 2025-02-27 - DOMPurify Configuration Gaps
**Vulnerability:** Found `DOMPurify.sanitize` usage that stripped `target="_blank"` attributes from external links, leading to broken functionality and potentially confusing behavior. Also, the external links lacked `rel="noopener noreferrer"`, which `DOMPurify` would strip if `target` was stripped, but if `target` was allowed, it would be vulnerable to reverse tabnabbing.
**Learning:** `DOMPurify` by default is very strict and strips `target` attributes. To allow them, `ADD_ATTR: ['target']` is needed. However, allowing `target` introduces tabnabbing risks, so `rel="noopener noreferrer"` MUST be added and preserved.
**Prevention:** When using `DOMPurify` for webviews, always check if `target="_blank"` is intended. If so, configure `DOMPurify` to allow `target` and ensure `rel="noopener noreferrer"` is present. Use explicit `DOMPurify` configuration rather than relying on defaults.
## 2025-02-27 - Unused safeUrl in suggestions panel webview
**Vulnerability:** Found that `getSafeUrl()` was computing a sanitized URL (enforcing http/https protocols) but the result `safeUrl` was never used. Instead, `DOMPurify.sanitize(url)` was used directly, which relies on DOMPurify's default scheme whitelist (potentially allowing `vscode:`, `mailto:`, etc.) and misses the stricter intended validation.
**Learning:** Always verify that security-critical variables (like sanitized inputs) are actually used in the rendering path. Redundant sanitization calls can sometimes mask the fact that the *stricter* check is being ignored.
**Prevention:** Use unused variable checks (e.g., in ESLint) to catch calculated-but-unused values. When implementing security controls, verify the data flow ensures the control is applied.
